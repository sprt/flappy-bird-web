'use strict';(function(g){function h(a,b){return Math.floor(Math.random()*(b-a+1))+a}var f=function(a){this._id=f._idCounter++;this._startTime=null;this._isWaitingForDelay=this._isRunning=!1;this._values={};this._from=a.from;this._to=a.to;this._duration=a.duration;this._onUpdate=a.onUpdate;this._iterations=a.iterations||1;this._delay=a.delay||0;this._sticks=void 0===a.sticks?!0:!!a.sticks;this._onAnimationStart=a.onAnimationStart;this._onAnimationEnd=a.onAnimationEnd;return this};f._idCounter=0;f._list=
{};f.updateAll=function(){Object.keys(f._list).forEach(function(a){f._list[a].update()})};f.stopAll=function(){Object.keys(f._list).forEach(function(a){f._list[a].stop()})};f.prototype.start=function(){this._isRunning||(this._onAnimationStart&&this._onAnimationStart.call(this._values),f._list[this._id]=this,this._startTime=(new Date).getTime(),this._isRunning=!0)};f.prototype.stop=function(){this._startTime=null;this._isRunning=!1;delete f._list[this._id];this._onAnimationEnd&&this._onAnimationEnd.call(this._values)};
f.prototype.update=function(){var a=this,b=(new Date).getTime()-this._startTime,e,d=!1;if(b<this._delay)this._isWaitingForDelay=!0;else if(this._isWaitingForDelay=!1,b-=this._delay,this._isRunning&&!this._isWaitingForDelay){e=b/this._duration;b>this._duration&&(e=0==Math.floor(e)%2?e-Math.floor(e):1-(e-Math.floor(e)));if(b>this._duration*this._iterations)if(this._sticks)e=this._iterations%2,d=Boolean(this._onAnimationEnd);else{this.stop();return}Object.keys(this._from).forEach(function(b){var d=a._from[b];
a._values[b]=d+e*(a._to[b]-d)});this._onUpdate.call(this._values);d&&this._onAnimationEnd.call(this._values)}};var k=function(){this._queue=[];this._cache={};this._loadedCount=0;this._callback=null;this.progress=0};k.prototype.queueDownload=function(a,b){this._queue.push({path:a,type:b})};k.prototype.getAsset=function(a){return this._cache[a]};k.prototype._onAssetLoad=function(a,b){this._cache[a]=b;this._loadedCount+=1;this.progress=this._loadedCount/this._queue.length;1==this.progress&&this._callback&&
this._callback(this)};k.prototype.downloadAll=function(a){var b=this;this._callback=a;this._queue.forEach(function(a){var d,c;"image"==a.type?(d=new Image,d.addEventListener("load",function(){b._onAssetLoad(a.path,d)},!1),d.src=a.path):"audio"==a.type?(d=document.createElement("audio"),d.preload="auto",d.addEventListener("loadeddata",function(){b._onAssetLoad(a.path,d)},!1),d.src=a.path):(c=new XMLHttpRequest,c.open("GET",a.path,!0),c.onload=function(){d=c.responseText;"json"==a.type&&(d=JSON.parse(d));
b._onAssetLoad(a.path,d)},c.send())})};var c=function(a,b,e){this.State={LOADING:0,HOME:1,START:2,PLAYING:3,GAMEOVER:4};this.$container=document.querySelector(a);this.$canvas=document.createElement("canvas");this.$container.appendChild(this.$canvas);this.ctx=this.$canvas.getContext("2d");this.state=this.State.LOADING;this.landScrollingSpeed=this.pipeScrollingSpeed=this.g=this.lastFrameTime=this.dt=this.t=null;this.sprite={};this.iosSounds={};this.playButton=this.birdie=null;this.pipePairs=[];this.landTilesRequired=
this.landTilesX=null;this.flapThisFrame=!1;this.DEFAULT_VOLUME=0.1;this.G=1200;this.FLAP_FORCE=350;this.SCROLLING_SPEED=135;this.LAND_WIDTH=336;this.LAND_HEIGHT=112;this.PIPE_WIDTH=52;this.PIPE_HEIGHT=320;this.PIPE_GAP=106;this.PIPE_DISTANCE=176;this.MAX_GAME_HEIGHT=this.LAND_HEIGHT+this.PIPE_HEIGHT+this.PIPE_GAP+44;this.initialize(b,e)};c.prototype.initialize=function(a,b){this.IS_IOS=!!navigator.userAgent.match(/iPhone OS/);this.IS_CHROME=!!navigator.userAgent.match(/Chrome/);this.SOUND_DISABLED=
this.IS_IOS||this.IS_CHROME;this.setCanvasSize(a,b);this.loadAssets(this.onAssetsLoaded.bind(this))};c.prototype.setCanvasSize=function(a,b){b=Math.min(this.MAX_GAME_HEIGHT,b);this.$container.style.width=a+"px";this.$container.style.height=b+"px";this.$canvas.width=a;this.$canvas.height=b;this.PIPE_MIN_MID=44+this.PIPE_GAP/2;this.PIPE_MAX_MID=b-this.LAND_HEIGHT-this.PIPE_GAP/2-44;this.pipePairsRequired=1+Math.ceil(this.$canvas.width/this.PIPE_DISTANCE);this.landTilesRequired=1+Math.ceil(this.$canvas.width/
this.LAND_WIDTH)};c.prototype.loadAssets=function(a){this.assetManager=new k;this.assetManager.queueDownload("/static/images/sprite.png","image");this.assetManager.queueDownload("/static/scripts/sprite.json","json");if(!this.SOUND_DISABLED){var b=this;["die","hit","point","swooshing","wing"].forEach(function(a){b.assetManager.queueDownload("/static/sounds/"+b.getSoundFilename(a),"audio")})}this.assetManager.downloadAll(a)};c.prototype.onAssetsLoaded=function(a){this.sprite.image=a.getAsset("/static/images/sprite.png");
this.sprite.data=a.getAsset("/static/scripts/sprite.json");this.setUpAnimations();this.changeState(this.State.HOME);this.addEventListeners();this.update()};c.prototype.setUpAnimations=function(){var a=this;this.animations={};Object.keys(this.State).forEach(function(b){a.animations[a.State[b]]={}});this.animations[this.State.HOME].birdie=new f({from:{y:this.$canvas.height/2-this.sprite.data.bird0_0.height/2},to:{y:this.$canvas.height/2-this.sprite.data.bird0_0.height},duration:375,iterations:Infinity,
sticks:!1,onUpdate:function(){a.birdie.y=this.y}});this.animations[this.State.START].birdie=new f({from:{y:this.$canvas.height/2-this.sprite.data.bird0_0.height/2},to:{y:this.$canvas.height/2-this.sprite.data.bird0_0.height},duration:375,iterations:Infinity,sticks:!1,onUpdate:function(){a.birdie.y=this.y}});this.animations[this.State.GAMEOVER].flash=new f({from:{opacity:0},to:{opacity:1},duration:75,iterations:2,sticks:!1,onUpdate:function(){a.ctx.fillStyle="rgba(255, 255, 255, "+this.opacity+")";
a.ctx.fillRect(0,0,a.$canvas.width,a.$canvas.height)}});this.animations[this.State.GAMEOVER].shake=new f({from:{},to:{},duration:750,sticks:!1,onUpdate:function(){var b="translate("+h(-2,2)+"px, "+h(-2,2)+"px)";a.$canvas.style.mozTransform=b;a.$canvas.style.webkitTransform=b;a.$canvas.style.transform=b},onAnimationEnd:function(){a.$canvas.style.mozTransform="none";a.$canvas.style.webkitTransform="none";a.$canvas.style.transform="none"}});this.animations[this.State.GAMEOVER].gameOverText=new f({from:{opacity:0},
to:{opacity:1},duration:200,delay:750,onUpdate:function(){a.ctx.globalAlpha=this.opacity;a.drawTile("text_game_over",a.$canvas.width/2-a.sprite.data.text_game_over.width/2,150);a.ctx.globalAlpha=1}});this.animations[this.State.GAMEOVER].scorePanel=new f({from:{y:this.$canvas.height},to:{y:210},duration:200,delay:1E3,onUpdate:function(){a.drawTile("score_panel",a.$canvas.width/2-a.sprite.data.score_panel.width/2,this.y)},onAnimationEnd:function(){null!==a.medalId&&a.drawTile("medals_"+a.medalId,a.$canvas.width/
2-a.sprite.data.text_game_over.width/2+15,this.y+44);a.drawNumber(a.$canvas.width/2-a.sprite.data.text_game_over.width/2+193,this.y+36,a.score,"medium","right");a.drawNumber(a.$canvas.width/2-a.sprite.data.text_game_over.width/2+193,this.y+78,a.getHighScore(),"medium","right");a.newHighScore&&a.drawTile("new",a.$canvas.width/2-a.sprite.data.text_game_over.width/2+125,this.y+60);a.playButton.displayed=!0}})};c.prototype.changeState=function(a){var b=this.state;switch(a){case this.State.HOME:this.changeBackground();
this.landTilesX=[];this.landScrollingSpeed=this.SCROLLING_SPEED;this.playButton={x:this.$canvas.width/2-this.sprite.data.button_play.width/2,y:this.$canvas.height-this.sprite.data.button_play.height-this.LAND_HEIGHT+10,displayed:!0};this.birdie={width:this.sprite.data.bird0_0.width,height:this.sprite.data.bird0_0.height,x:this.$canvas.width/2-this.sprite.data.bird0_0.width/2,y:this.$canvas.height/2-this.sprite.data.bird0_0.height/2,vy:0,version:h(0,2),frame:0,frameTime:150,lastFrameTime:null,direction:0,
lastDirectionChangeTime:null,angle:0};for(b=0;b<this.landTilesRequired;b++)this.landTilesX[b]=b*this.LAND_WIDTH;break;case this.State.START:f.stopAll();this.playButton.displayed=!1;b!=this.State.HOME&&this.changeBackground();this.landScrollingSpeed=this.SCROLLING_SPEED;this.score=0;this.newHighScore=!1;this.medalId=null;this.birdie.x=this.$canvas.width/4-this.sprite.data.bird0_0.width/2;this.birdie.y=this.$canvas.height/2-this.sprite.data.bird0_0.height/2;this.birdie.frame=0;this.birdie.frameTime=
150;this.birdie.lastFrameTime=null;this.birdie.direction=0;this.birdie.lastDirectionChangeTime=null;this.birdie.angle=0;b!=this.State.START&&(this.birdie.version=h(0,2));for(b=0;b<this.pipePairsRequired;b++)this.pipePairs[b]={x:1.5*this.$canvas.width+this.PIPE_WIDTH/2+this.PIPE_DISTANCE*b,my:h(this.PIPE_MIN_MID,this.PIPE_MAX_MID)};this.pipePairAheadId=0;break;case this.State.PLAYING:this.animations[this.State.START].birdie.stop();this.g=this.G;this.landScrollingSpeed=this.pipeScrollingSpeed=this.SCROLLING_SPEED;
this.birdie.frameTime=75;break;case this.State.GAMEOVER:this.landScrollingSpeed=this.pipeScrollingSpeed=0,this.playButton.x=this.$canvas.width/2-this.sprite.data.button_play.width/2,this.playButton.y=350}this.state=a;this.startStateAnimations()};c.prototype.getSoundFilename=function(a){var b=!!document.createElement("audio").canPlayType("audio/ogg");return"sfx_"+a+("wing"!=a&&b?".ogg":".mp3")};c.prototype.getSound=function(a){var b="/static/sounds/"+this.getSoundFilename(a);return this.IS_IOS?(this.iosSounds.hasOwnProperty(a)&&
(this.iosSounds[a]=document.createElement("audio"),this.iosSounds[a].src=b),this.iosSounds[a]):this.assetManager.getAsset(b)};c.prototype.playSound=function(a){this.SOUND_DISABLED||(a=this.getSound(a).cloneNode(),a.volume=this.DEFAULT_VOLUME,a.play())};c.prototype.changeBackground=function(){var a={bg_day:"#4ec0ca",bg_night:"#008793"},b=Object.keys(a)[h(0,1)],a=a[b],e=this.$canvas.width/this.sprite.data[b].width,d=-this.sprite.data[b].x*e,b=this.$canvas.height-this.sprite.data[b].height*e*(1-this.LAND_HEIGHT/
this.sprite.data[b].height)-this.LAND_HEIGHT;this.$canvas.style.backgroundImage="url(/static/images/sprite.png)";this.$canvas.style.backgroundRepeat="no-repeat";this.$canvas.style.backgroundColor=a;this.$canvas.style.backgroundPosition=d+"px "+b+"px";this.$canvas.style.backgroundSize=this.sprite.image.width*e+"px "+this.sprite.image.height*e+"px"};c.prototype.startStateAnimations=function(){var a=this.animations[this.state];Object.keys(a).forEach(function(b){a[b].start()})};c.prototype.getHighScore=
function(){return parseInt(g.localStorage.getItem("highScore"),10)||0};c.prototype.setHighScore=function(a){g.localStorage.setItem("highScore",a.toString())};c.prototype.addEventListeners=function(){document.addEventListener("mousedown",this.onUIEvent.bind(this),!1);document.addEventListener("mouseup",this.onUIEvent.bind(this),!1);document.addEventListener("keyup",this.onUIEvent.bind(this),!1);document.addEventListener("keydown",this.onUIEvent.bind(this),!1);document.addEventListener("touchstart",
this.onUIEvent.bind(this),!1);document.addEventListener("touchend",this.onUIEvent.bind(this),!1)};c.prototype.getAbstractUIEvent=function(a){var b,e,d={};if(-1!=["mousedown","touchstart","keydown"].indexOf(a.type))e="start";else if(-1!=["mouseup","touchend","keyup"].indexOf(a.type))e="end";else return null;a instanceof g.MouseEvent||a instanceof g.TouchEvent?(b="mousetouch",d.coords="touchend"==a.type?{x:a.changedTouches[0].clientX,y:a.changedTouches[0].clientY}:{x:a.layerX,y:a.layerY}):a instanceof
g.KeyboardEvent&&(b="keyboard",d.keyCode=a.keyCode);return{type:b,moment:e,data:d}};c.prototype.onUIEvent=function(a){var b=this.getAbstractUIEvent(a),e,d;if(!("mousetouch"==b.type&&a.target!=this.$canvas||"keyboard"==b.type&&-1==[13,32,38,87].indexOf(b.data.keyCode)))if("mousetouch"==b.type&&(e=b.data.coords.x,d=b.data.coords.y),this.playButton.displayed){if("keyboard"==b.type||"mousetouch"==b.type&&e>=this.playButton.x&&e<=this.playButton.x+this.sprite.data.button_play.width&&d>=this.playButton.y&&
d<=this.playButton.y+this.sprite.data.button_play.height)"start"==b.moment?this.playButton.y+=2:(this.playButton.y-=2,this.playButton.displayed=!1,this.playSound("swooshing"),this.changeState(this.State.START)),a.preventDefault()}else"start"==b.moment&&(-1!=[this.State.START,this.State.PLAYING].indexOf(this.state)&&0<=this.birdie.y&&(this.playSound("wing"),this.flapThisFrame=!0),this.state==this.State.START&&this.changeState(this.State.PLAYING),a.preventDefault())};c.prototype.updateBirdieAngle=function(){null!==
this.birdie.lastDirectionChangeTime&&(0<=this.birdie.direction?(this.birdie.angle-=2*this.birdie.vy*this.dt,this.birdie.angle=Math.max(-20,this.birdie.angle)):(this.birdie.angle-=this.birdie.vy/2*this.dt,this.birdie.angle=Math.min(90,this.birdie.angle)))};c.prototype.updateLand=function(){var a=this;this.landTilesX.forEach(function(b,e,d){0>=b+a.LAND_WIDTH&&(d[e]=Math.max.apply(Math,d)+a.LAND_WIDTH);d[e]-=a.landScrollingSpeed*a.dt})};c.prototype.updateBirdie=function(){var a=this.birdie.direction;
this.state>this.State.START&&(this.flapThisFrame?(this.birdie.vy=this.FLAP_FORCE,this.birdie.direction=1):(this.birdie.vy-=this.g*this.dt,this.birdie.direction=0>this.birdie.vy?-1:0<this.birdie.vy?1:0),this.birdie.direction!=a&&(this.birdie.lastDirectionChangeTime=this.t),this.birdie.y-=this.birdie.vy*this.dt,this.birdie.y=Math.min(this.$canvas.height-this.birdie.height-this.sprite.data.land.height,this.birdie.y),this.updateBirdieAngle());this.state==this.State.GAMEOVER?this.birdie.frame=1:null===
this.birdie.lastFrameTime?(this.birdie.frame=0,this.birdie.lastFrameTime=this.t):this.t-this.birdie.lastFrameTime>this.birdie.frameTime&&(this.birdie.frame++,3==this.birdie.frame&&(this.birdie.frame=0),this.birdie.lastFrameTime=this.t)};c.prototype.getBirdieBoundingBox=function(){return{x:this.birdie.x+4,y:this.birdie.y,width:this.birdie.width-10,height:this.birdie.height}};c.prototype.updateScore=function(){this.getBirdieBoundingBox().x>=this.pipePairs[this.pipePairAheadId].x-this.PIPE_WIDTH/2&&
(this.playSound("point"),this.score++,this.pipePairAheadId++,this.pipePairAheadId==this.pipePairs.length&&(this.pipePairAheadId=0))};c.prototype.updatePipePairs=function(){var a=this;this.pipePairs.forEach(function(b,e,d){d[e].x-=a.pipeScrollingSpeed*a.dt;0>=b.x+a.PIPE_WIDTH/2&&(d[e].x=d[0<e?e-1:d.length-1].x+a.PIPE_DISTANCE,d[e].my=h(a.PIPE_MIN_MID,a.PIPE_MAX_MID))})};c.prototype.update=function(){this.t=(new Date).getTime();null===this.lastFrameTime&&(this.lastFrameTime=this.t);this.dt=(this.t-
this.lastFrameTime)/1E3;this.updateLand();this.updateBirdie();this.state>=this.State.START&&(this.updatePipePairs(),this.updateScore());this.checkBirdieCollision();this.draw();this.flapThisFrame=!1;this.lastFrameTime=this.t;g.requestAnimationFrame(this.update.bind(this))};c.prototype.checkBirdieCollision=function(){this.isBirdieColliding()&&this.handleBirdieCollision()};c.prototype.isBirdieColliding=function(){var a=this.getBirdieBoundingBox(),b,e;if(a.y+a.height>=this.$canvas.height-this.sprite.data.land.height)return!0;
for(b=0;b<this.pipePairs.length;b++)if(e=this.getPipeData(this.pipePairs[b]),this.collide(a,e.down)||this.collide(a,e.up))return!0;return!1};c.prototype.collide=function(a,b){return a.x<=b.x+b.width&&b.x<=a.x+a.width&&a.y<=b.y+b.height&&b.y<=a.y+a.height};c.prototype.onGameOver=function(){var a=this;this.playSound("hit");setTimeout(function(){a.playSound("die")},250);this.score>this.getHighScore()&&(this.setHighScore(this.score),this.newHighScore=!0);40<=this.score?this.medalId=0:30<=this.score?this.medalId=
1:20<=this.score?this.medalId=2:10<=this.score&&(this.medalId=3);this.changeState(this.State.GAMEOVER)};c.prototype.handleBirdieCollision=function(){if(this.state!=this.State.GAMEOVER)this.onGameOver()};c.prototype.drawTile=function(a,b,e,d){a=this.sprite.data[a];this.ctx.drawImage(this.sprite.image,a.x,a.y,a.width,a.height,b,e,a.width*(d||1),a.height*(d||1))};c.prototype.drawRotatedTile=function(a,b,e,d){var c=this.sprite.data[a];this.ctx.save();this.ctx.translate(b+c.width/2,e+c.height/2);this.ctx.rotate(d*
Math.PI/180);this.drawTile(a,-c.width/2,-c.height/2);this.ctx.restore()};c.prototype.drawNumber=function(a,b,e,d,c){e=e.toString();var f=0,g=0,h="large"==d?48:0,l,m,k;switch(d){case "large":k="font_0";break;default:k="number_score_0"}for(l=0;l<e.length;l++)m=this.sprite.data[k+(h+l)].width,f+="large"==d?m-4:m;switch(c){case "center":a-=f/2;break;case "right":a-=f;break}for(l=0;l<e.length;l++)c=k+(h+parseInt(e[l],10)),m=this.sprite.data[c].width,this.drawTile(c,a+g,b),g+="large"==d?m-4:m};c.prototype.drawBirdie=
function(){this.drawRotatedTile("bird"+this.birdie.version+"_"+this.birdie.frame,this.birdie.x,this.birdie.y,this.birdie.angle)};c.prototype.draw=function(){var a=this;this.ctx.clearRect(0,0,this.$canvas.width,this.$canvas.height);this.state==this.State.HOME&&this.drawTile("title",this.$canvas.width/2-this.sprite.data.title.width/2,this.$canvas.height/2-90);this.state>=this.State.START&&(this.drawPipes(),this.drawNumber(this.$canvas.width/2,this.$canvas.height/5-this.sprite.data.font_048.width,this.score,
"large","center"));this.drawBirdie();this.landTilesX.forEach(function(b){a.drawTile("land",b,a.$canvas.height-a.sprite.data.land.height)});this.playButton.displayed&&this.drawTile("button_play",this.playButton.x,this.playButton.y);f.updateAll()};c.prototype.getPipeData=function(a){return{down:{x:a.x-this.PIPE_WIDTH/2,y:a.my-this.sprite.data.pipe_down.height-this.PIPE_GAP/2,width:this.sprite.data.pipe_down.width,height:this.sprite.data.pipe_down.height},up:{x:a.x-this.PIPE_WIDTH/2,y:a.my+this.PIPE_GAP/
2,width:this.sprite.data.pipe_up.width,height:this.sprite.data.pipe_up.height}}};c.prototype.drawPipes=function(){var a=this;this.pipePairs.map(this.getPipeData.bind(this)).forEach(function(b){a.drawTile("pipe_down",b.down.x,b.down.y);a.drawTile("pipe_up",b.up.x,b.up.y)})};var n,p;480>g.innerWidth?(n=g.innerWidth,p=g.innerHeight):(n=640,p=480);new c("#flappy-bird",n,p)})(window);
